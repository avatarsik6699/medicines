# Руководство по работе с миграциями

## Содержание
1. [Введение](#введение)
2. [Основные команды](#основные-команды)
3. [Типичный workflow](#типичный-workflow)
4. [Рекомендации и лучшие практики](#рекомендации-и-лучшие-практики)
5. [Решение проблем](#решение-проблем)
6. [Работа с директориями src и dist](#работа-с-директориями-src-и-dist)

## Введение

Миграции - это способ отслеживать и применять изменения в структуре базы данных. В нашем проекте мы используем TypeORM для управления миграциями.

### Важные моменты
- Миграции применяются из скомпилированной директории `dist`
- Все команды автоматически собирают проект перед выполнением
- Миграции выполняются в хронологическом порядке
- Каждая миграция должна быть обратимой (иметь метод `down`)

## Основные команды

### Генерация миграций
```bash
# Генерация новой миграции на основе изменений в сущностях
npm run migration:generate

# Создание пустой миграции (для ручного написания)
npm run migration:create
```

### Применение миграций
```bash
# Применение всех pending миграций
npm run migration:run

# Откат последней миграции
npm run migration:revert

# Проверка статуса миграций
npm run migration:status
```

### Управление базой данных
```bash
# Удаление всех таблиц
npm run db:drop

# Сброс базы данных (удаление + применение миграций)
npm run db:reset

# Полное обновление (сборка + сброс + миграции)
npm run db:refresh
```

## Типичный workflow

### 1. Разработка и обновление сущностей
1. Внесите изменения в сущности в `src/core/*/entities`
2. Убедитесь, что изменения корректны и соответствуют требованиям

### 2. Генерация миграции
1. Запустите генерацию миграции:
   ```bash
   npm run migration:generate
   ```
2. Проверьте сгенерированный файл в `src/shared/setup/db/migrations`
3. При необходимости отредактируйте миграцию вручную

### 3. Применение миграции
1. Примените миграцию:
   ```bash
   npm run migration:run
   ```
2. Проверьте статус:
   ```bash
   npm run migration:status
   ```

### 4. Тестирование
1. Проверьте, что все изменения применились корректно
2. Протестируйте функциональность, связанную с измененными сущностями

## Рекомендации и лучшие практики

### Безопасность
1. **Всегда делайте бэкап** базы данных перед применением миграций в production
2. **Тестируйте миграции** на тестовой базе данных
3. **Не изменяйте существующие миграции** после применения в production

### Структура миграций
1. Каждая миграция должна иметь:
   - Метод `up` для применения изменений
   - Метод `down` для отката изменений
   - Проверки существования таблиц/колонок

### Пример безопасной миграции
```typescript
export class Migration1234567890 implements MigrationInterface {
    async up(queryRunner: QueryRunner): Promise<void> {
        // Проверяем существование таблицы
        const tableExists = await queryRunner.hasTable('table_name');
        if (!tableExists) {
            await queryRunner.createTable(/* ... */);
        }

        // Проверяем существование колонки
        const columnExists = await queryRunner.hasColumn('table_name', 'column_name');
        if (!columnExists) {
            await queryRunner.addColumn('table_name', /* ... */);
        }
    }

    async down(queryRunner: QueryRunner): Promise<void> {
        // Код для отката изменений
    }
}
```

## Решение проблем

### Проблема: Миграция не применяется
1. Проверьте, что проект собран:
   ```bash
   npm run build
   ```
2. Проверьте статус миграций:
   ```bash
   npm run migration:status
   ```
3. Проверьте логи TypeORM

### Проблема: Ошибка при применении миграции
1. Попробуйте откатить миграцию:
   ```bash
   npm run migration:revert
   ```
2. Исправьте ошибку в миграции
3. Примените миграцию снова:
   ```bash
   npm run migration:run
   ```

### Проблема: Несоответствие структуры базы данных
1. Сделайте бэкап базы данных
2. Выполните полный сброс:
   ```bash
   npm run db:refresh
   ```

### Проблема: Конфликт миграций
1. Проверьте порядок миграций
2. Убедитесь, что нет дублирующихся миграций
3. При необходимости создайте новую миграцию для исправления конфликта

## Дополнительные советы

1. **Документируйте изменения** в комментариях к миграции
2. **Используйте транзакции** для обеспечения атомарности операций
3. **Тестируйте откат миграций** перед применением в production
4. **Следите за порядком** применения миграций
5. **Регулярно делайте бэкапы** базы данных

## Полезные команды для отладки

```bash
# Проверка статуса миграций
npm run migration:status

# Просмотр SQL-запросов
npm run migration:run -- --verbose

# Откат последней миграции
npm run migration:revert

# Полный сброс базы данных
npm run db:refresh
```

## Работа с директориями src и dist

### Почему миграции применяются из dist, а не из src?

1. **TypeORM работает с JavaScript, а не с TypeScript**:
   - TypeORM - это JavaScript/TypeScript ORM, но его ядро работает с JavaScript
   - Когда TypeORM выполняет миграции, он загружает файлы через Node.js, который по умолчанию работает с JavaScript
   - Даже если мы используем TypeScript, в runtime все файлы должны быть скомпилированы в JavaScript

2. **Процесс выполнения миграций**:
   ```typescript
   // data-source-options-factory.ts
   const [{ paths: entities }, { paths: migrations }] = await Promise.all([
       pathResolver.getPaths({ required: true, patterns: ["**/*.entity{.ts,.js}"] }),
       pathResolver.getPaths({
           required: false,
           patterns: ["**/migrations/*{.ts,.js}"],
       }),
   ]);
   ```
   - TypeORM ищет файлы миграций в скомпилированной директории `dist`
   - Это происходит потому, что в production среде у нас нет TypeScript файлов, только скомпилированные JavaScript файлы

3. **Почему это важно**:
   - **Консистентность**: Одинаковое поведение в development и production
   - **Производительность**: Не нужно компилировать TypeScript на лету
   - **Надежность**: Меньше шансов на ошибки при выполнении миграций

4. **Как это работает**:
   ```
   src/migrations/migration.ts (TypeScript)
   ↓ (компиляция)
   dist/migrations/migration.js (JavaScript)
   ↓ (выполнение)
   TypeORM применяет миграцию
   ```

5. **Почему нельзя использовать `src`**:
   - В production среде файлы из `src` не существуют
   - TypeORM не может напрямую выполнять TypeScript файлы
   - Это нарушило бы принцип "build once, deploy many"

6. **Преимущества такого подхода**:
   - Гарантия, что применяются те же миграции, что были протестированы
   - Нет необходимости в дополнительной компиляции при выполнении миграций
   - Единый процесс для всех окружений (development, staging, production)

### Практические рекомендации

1. **Всегда делайте build перед миграциями**:
   ```bash
   npm run build
   npm run migration:run
   ```

2. **Проверяйте скомпилированные файлы**:
   - Убедитесь, что миграции корректно скомпилированы в `dist`
   - Проверьте, что все изменения из `src` попали в `dist`

3. **При отладке**:
   - Проверяйте файлы в обеих директориях
   - Убедитесь, что изменения в `src` корректно отражаются в `dist`
   - Используйте `--verbose` флаг для просмотра путей к файлам

4. **В production**:
   - Используйте только файлы из `dist`
   - Не пытайтесь применять миграции из `src`
   - Убедитесь, что все необходимые файлы включены в сборку 